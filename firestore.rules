rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Règles pour les salles de ventes
    match /auctionHouses/{houseId} {
      // Permettre la lecture et l'écriture pour les utilisateurs authentifiés (anonymes inclus)
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les devis
    match /quotes/{quoteId} {
      // Permettre la lecture et l'écriture pour les utilisateurs authentifiés (anonymes inclus)
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les colis/expéditions
    match /shipments/{shipmentId} {
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les clients
    match /clients/{clientId} {
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les destinataires
    match /recipients/{recipientId} {
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les liens de paiement
    match /paymentLinks/{linkId} {
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les paiements
    match /payments/{paymentId} {
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les paiements Stripe Connect
    match /paiements/{paiementId} {
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les messages emails
    match /emailMessages/{messageId} {
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les comptes emails
    match /emailAccounts/{accountId} {
      allow read, write: if request.auth != null;
    }
    
    // Règles pour les notifications
    match /notifications/{notificationId} {
      // Lecture: seulement si la notification appartient à l'utilisateur
      allow read: if request.auth != null 
        && request.auth.uid == resource.data.clientSaasId;
      
      // Suppression: seulement si la notification appartient à l'utilisateur
      allow delete: if request.auth != null 
        && request.auth.uid == resource.data.clientSaasId;
      
      // Création: seulement par le backend (via Firebase Admin SDK)
      // Les utilisateurs ne peuvent pas créer de notifications directement
      allow create: if false;
      
      // Mise à jour: interdit (on supprime plutôt que de modifier)
      allow update: if false;
    }
    
    // Règles pour les groupements d'expédition
    match /shipmentGroups/{groupId} {
      // Lecture: seulement si le groupement appartient au compte SaaS de l'utilisateur
      allow read: if request.auth != null 
        && request.auth.uid == resource.data.saasAccountId;
      
      // Création: seulement pour les utilisateurs authentifiés de leur propre compte
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.saasAccountId;
      
      // Mise à jour: seulement si le groupement appartient à l'utilisateur
      // et seulement pour les groupements non expédiés
      allow update: if request.auth != null 
        && request.auth.uid == resource.data.saasAccountId
        && resource.data.status != 'shipped';
      
      // Suppression: seulement si le groupement appartient à l'utilisateur
      // et seulement pour les groupements non payés/expédiés
      allow delete: if request.auth != null 
        && request.auth.uid == resource.data.saasAccountId
        && resource.data.status != 'paid'
        && resource.data.status != 'shipped';
    }
    
    // Règles pour les bordereaux
    match /bordereaux/{bordereauId} {
      // Lecture: seulement si le bordereau appartient au compte SaaS de l'utilisateur
      allow read: if request.auth != null 
        && request.auth.uid == resource.data.saasAccountId;
      
      // Création: seulement pour les utilisateurs authentifiés de leur propre compte
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.saasAccountId;
      
      // Mise à jour: seulement si le bordereau appartient à l'utilisateur
      allow update: if request.auth != null 
        && request.auth.uid == resource.data.saasAccountId;
      
      // Suppression: seulement si le bordereau appartient à l'utilisateur
      allow delete: if request.auth != null 
        && request.auth.uid == resource.data.saasAccountId;
    }
    
    // Règles pour les cartons (SaaS-isolated)
    match /cartons/{cartonId} {
      // Fonction helper pour récupérer le saasAccountId de l'utilisateur
      function getUserSaasAccountId() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.saasAccountId;
      }
      
      // Lecture: seulement les cartons du compte SaaS de l'utilisateur
      allow read: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId();
      
      // Création: seulement pour les utilisateurs authentifiés de leur propre compte
      allow create: if request.auth != null 
        && request.resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.inner_length > 0
        && request.resource.data.inner_width > 0
        && request.resource.data.inner_height > 0
        && request.resource.data.packaging_price >= 0;
      
      // Mise à jour: seulement les cartons du compte SaaS de l'utilisateur
      allow update: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.saasAccountId == getUserSaasAccountId();
      
      // Suppression: seulement les cartons du compte SaaS de l'utilisateur
      allow delete: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId();
    }
    
    // ==========================================
    // RÈGLES POUR LA GRILLE TARIFAIRE D'EXPÉDITION
    // ==========================================
    
    // Fonction helper globale pour récupérer le saasAccountId
    function getUserSaasAccountId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.saasAccountId;
    }
    
    // Règles pour les zones d'expédition
    match /shippingZones/{zoneId} {
      // Lecture: seulement les zones du compte SaaS de l'utilisateur
      allow read: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId();
      
      // Création: seulement pour les utilisateurs authentifiés de leur propre compte
      allow create: if request.auth != null 
        && request.resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.name is string
        && request.resource.data.code is string
        && request.resource.data.countries is list;
      
      // Mise à jour: seulement les zones du compte SaaS de l'utilisateur
      allow update: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.saasAccountId == getUserSaasAccountId();
      
      // Suppression: soft delete uniquement (via update isActive = false)
      allow delete: if false;
    }
    
    // Règles pour les services d'expédition
    match /shippingServices/{serviceId} {
      // Lecture: seulement les services du compte SaaS de l'utilisateur
      allow read: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId();
      
      // Création: seulement pour les utilisateurs authentifiés de leur propre compte
      allow create: if request.auth != null 
        && request.resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.name is string;
      
      // Mise à jour: seulement les services du compte SaaS de l'utilisateur
      allow update: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.saasAccountId == getUserSaasAccountId();
      
      // Suppression: soft delete uniquement (via update isActive = false)
      allow delete: if false;
    }
    
    // Règles pour les tranches de poids
    match /weightBrackets/{bracketId} {
      // Lecture: seulement les tranches du compte SaaS de l'utilisateur
      allow read: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId();
      
      // Création: seulement pour les utilisateurs authentifiés de leur propre compte
      allow create: if request.auth != null 
        && request.resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.maxWeightKg > 0
        && request.resource.data.order >= 0;
      
      // Mise à jour: seulement les tranches du compte SaaS de l'utilisateur
      allow update: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.saasAccountId == getUserSaasAccountId();
      
      // Suppression: hard delete autorisé (pas de dépendances critiques)
      allow delete: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId();
    }
    
    // Règles pour les tarifs d'expédition
    match /shippingRates/{rateId} {
      // Lecture: seulement les tarifs du compte SaaS de l'utilisateur
      allow read: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId();
      
      // Création: seulement pour les utilisateurs authentifiés de leur propre compte
      allow create: if request.auth != null 
        && request.resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.zoneId is string
        && request.resource.data.serviceId is string
        && request.resource.data.weightBracketId is string
        && (request.resource.data.price == null || request.resource.data.price >= 0);
      
      // Mise à jour: seulement les tarifs du compte SaaS de l'utilisateur
      allow update: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.saasAccountId == getUserSaasAccountId();
      
      // Suppression: autorisée (pour nettoyer les tarifs obsolètes)
      allow delete: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId();
    }
    
    // Règles pour les paramètres d'expédition
    match /shippingSettings/{settingsId} {
      // Lecture: seulement les paramètres du compte SaaS de l'utilisateur
      allow read: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId();
      
      // Création: seulement pour les utilisateurs authentifiés de leur propre compte
      allow create: if request.auth != null 
        && request.resource.data.saasAccountId == getUserSaasAccountId();
      
      // Mise à jour: seulement les paramètres du compte SaaS de l'utilisateur
      allow update: if request.auth != null 
        && resource.data.saasAccountId == getUserSaasAccountId()
        && request.resource.data.saasAccountId == getUserSaasAccountId();
      
      // Suppression: interdite (on garde toujours les paramètres)
      allow delete: if false;
    }
    
    // Règles pour les utilisateurs (users)
    match /users/{uid} {
      // L'utilisateur peut lire et écrire son propre document
      allow read, write: if request.auth != null 
        && request.auth.uid == uid;
    }
    
    // Règles pour les comptes SaaS (saasAccounts)
    match /saasAccounts/{accountId} {
      // Le propriétaire peut lire et écrire son compte SaaS
      allow read, write: if request.auth != null 
        && resource.data.ownerUid == request.auth.uid;
      
      // Permettre la création si l'utilisateur est le propriétaire
      allow create: if request.auth != null 
        && request.resource.data.ownerUid == request.auth.uid;
    }
  }
}

